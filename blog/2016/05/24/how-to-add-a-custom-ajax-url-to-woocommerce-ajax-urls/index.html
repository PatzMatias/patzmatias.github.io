
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>How to Add a Custom AJAX URL to WooCommerce AJAX URLs - Patrick A. Matias</title>
  <meta name="author" content="Patrick A. Matias">

  
  <meta name="description" content="Patrick A. Matias Blog How to Add a Custom AJAX URL to WooCommerce AJAX URLs written May 24th, 2016 in AJAX,, JS,, PHP, WooCommerce,, Wordpress, I& &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://PatzMatias.github.io/blog/2016/05/24/how-to-add-a-custom-ajax-url-to-woocommerce-ajax-urls">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Patrick A. Matias" type="application/atom+xml">
  <!--FONTS-->
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Kaushan+Script' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>
  <!--FONTS-->
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="/javascripts/jquery-ui-1.10.4.custom.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  

</head>

  <body id="top">
  	<div class="preloader1"></div>
  	<div class="nav-icons"> 
	  	<div class="showslide" title="Menu">
			<p><i class="fa fa-bars"></i></p>
		</div>
		<div class="home-icon" title="Home">
		  	<a href="/">
		      <img src="/images/home.png"/>
		    </a>
		</div>
		<div class="blog" title="Blog">
		  	<a href="/#blog">
		      <p><i class="fa fa-edit"></i></p>
		    </a>
		</div>
	</div>
    <div class="back-to-top hidden-xs" data-0="opacity: 0;" data-1000="opacity: 1;">
    	<a href="#top"><i class="fa fa-chevron-up"></i></a>
    </div>
	<div id="slide">
	  <aside class="sidebar">
	    
	      <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/05/24/how-to-add-a-custom-ajax-url-to-woocommerce-ajax-urls/">How to Add a Custom AJAX URL to WooCommerce AJAX URLs</a>
        <p class="date">2016-05-24 16:11:00 +0800</p>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/10/making-angularjs-and-wordpress-work-together/">Making AngularJS and Wordpress Work Together</a>
        <p class="date">2015-06-10 22:17:56 +0800</p>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/02/learning-ruby-and-rails/">Learning Ruby and Rails</a>
        <p class="date">2015-06-02 18:01:23 +0800</p>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos
  
  <a href="https://github.com/PatzMatias">@PatzMatias</a>
  
  </h1>
  <ul id="gh_repos">
    <li class="loading"><span>Status updating</span> &nbsp;<i class="fa fa-spinner fa-spin"></i></li>
  </ul>
</section>



<section class="googleplus">
  <h1>Social</h1>
  <ul>
  	<li>
	  	<i class="fa fa-google-plus-square"></i>
	    <a class="social-links" href="https://plus.google.com/117521965885043360258?rel=author">
	      @PatzMatias
	    </a>
	</li>
	<li>
		<i class="fa fa-facebook-square"></i>
		<a class="social-links" href="https://www.facebook.com/patrick.matias">
		fb.com/patrick.matias
	 	</a>
	</li>
 </ul>
</section>



	    
	  </aside>
	</div>
    <div class="post-header" id="post-header">
    <div class="container-fluid">
       <div class="row">
        <div class="col-md-6 col-md-offset-3">
          <h3 class="title">Patrick A. Matias</h3>
          <div class="subtitle">Blog</div>
        </div>
     </div>
    </div>
</div>
  

</div>
<article role="article" class="full-single-article">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-6 col-md-offset-3 paper">
        <h1>How to Add a Custom AJAX URL to WooCommerce AJAX URLs</h1>
        <div class="meta">
          written 








  



<time datetime="2016-05-24T16:11:00+08:00" pubdate data-updated="true">May 24<span>th</span>, 2016</time>
          

in
<span class="categories">
  
    <a class='category' href='/blog/categories/ajax/'>AJAX,</a>, <a class='category' href='/blog/categories/js/'>JS,</a>, <a class='category' href='/blog/categories/php/'>PHP</a>, <a class='category' href='/blog/categories/woocommerce/'>WooCommerce,</a>, <a class='category' href='/blog/categories/wordpress/'>Wordpress,</a>
  
</span>


        </div>
        <p>I&rsquo;ve been having an awesome time working with the WooCommerce plugin lately and found many things I liked and didn&rsquo;t like about it. I wrote this article to tackle one thing that I didn&rsquo;t like about it and how we could improve it.</p>

<p>If you&rsquo;ve used WooCommerce before you&rsquo;ll find parts of the system that uses AJAX and parts that do not, and which sometimes results into inconsistencies to it&rsquo;s UX. <!-- more -->For example, their mini-cart widget, when activated the users would see their cart contents in it. Upon pressing the <strong>Add to cart</strong> button in the shop page a product would be added in the mini-cart and it is processed via ajax. But when a user clicks the remove button from one of the items in the mini-cart the page refreshes just to update it&rsquo;s UI. Isn&rsquo;t that inconsistent with the UX of the carts process flow? And since I mentioned it, I&rsquo;ll tell you what I did to solve this dilemma.</p>

<hr />

<h3><strong>Step 1. Extending WC_AJAX class</strong></h3>

<p> Initially, I searched through WooCommerce&rsquo;s plugin files for the function or class where I can attach my own ajax endpoints and I found this part of the WC_AJAX Class that could be seen in <code>woocommerce/includes/class-wc-ajax.php</code>.</p>

<p>Source: <a href="https://github.com/woothemes/woocommerce/blob/master/includes/" title="https://github.com/woothemes/woocommerce/blob/master/includes/">https://github.com/woothemes/woocommerce/blob/master/includes/</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;!-- Starts at line 87 --&gt;
</span><span class='line'>/**
</span><span class='line'> + Hook in methods - uses WordPress ajax handlers (admin-ajax).
</span><span class='line'> */
</span><span class='line'>public static function add_ajax_events() {
</span><span class='line'>    // woocommerce_EVENT =&gt; nopriv
</span><span class='line'>    $ajax_events = array(
</span><span class='line'>        'get_refreshed_fragments'                          =&gt; true,
</span><span class='line'>        'apply_coupon'                                     =&gt; true,
</span><span class='line'>        'remove_coupon'                                    =&gt; true,
</span><span class='line'>        'update_shipping_method'                           =&gt; true,
</span><span class='line'>        'get_cart_totals'                                  =&gt; true,
</span><span class='line'>        'update_order_review'                              =&gt; true,
</span><span class='line'>        'add_to_cart'                                      =&gt; true,
</span><span class='line'>        'checkout'                                         =&gt; true,
</span><span class='line'>        'get_variation'                                    =&gt; true,
</span><span class='line'>        'feature_product'                                  =&gt; false,
</span><span class='line'>        'mark_order_status'                                =&gt; false,
</span><span class='line'>        'add_attribute'                                    =&gt; false,
</span><span class='line'>        'add_new_attribute'                                =&gt; false,
</span><span class='line'>        'remove_variation'                                 =&gt; false,
</span><span class='line'>        'remove_variations'                                =&gt; false,
</span><span class='line'>        'save_attributes'                                  =&gt; false,
</span><span class='line'>        'add_variation'                                    =&gt; false,
</span><span class='line'>        'link_all_variations'                              =&gt; false,
</span><span class='line'>        'revoke_access_to_download'                        =&gt; false,
</span><span class='line'>        'grant_access_to_download'                         =&gt; false,
</span><span class='line'>        'get_customer_details'                             =&gt; false,
</span><span class='line'>        'add_order_item'                                   =&gt; false,
</span><span class='line'>        'add_order_fee'                                    =&gt; false,
</span><span class='line'>        'add_order_shipping'                               =&gt; false,
</span><span class='line'>        'add_order_tax'                                    =&gt; false,
</span><span class='line'>        'remove_order_item'                                =&gt; false,
</span><span class='line'>        'remove_order_tax'                                 =&gt; false,
</span><span class='line'>        'reduce_order_item_stock'                          =&gt; false,
</span><span class='line'>        'increase_order_item_stock'                        =&gt; false,
</span><span class='line'>        'add_order_item_meta'                              =&gt; false,
</span><span class='line'>        'remove_order_item_meta'                           =&gt; false,
</span><span class='line'>        'calc_line_taxes'                                  =&gt; false,
</span><span class='line'>        'save_order_items'                                 =&gt; false,
</span><span class='line'>        'load_order_items'                                 =&gt; false,
</span><span class='line'>        'add_order_note'                                   =&gt; false,
</span><span class='line'>        'delete_order_note'                                =&gt; false,
</span><span class='line'>        'json_search_products'                             =&gt; false,
</span><span class='line'>        'json_search_products_and_variations'              =&gt; false,
</span><span class='line'>        'json_search_grouped_products'                     =&gt; false,
</span><span class='line'>        'json_search_downloadable_products_and_variations' =&gt; false,
</span><span class='line'>        'json_search_customers'                            =&gt; false,
</span><span class='line'>        'term_ordering'                                    =&gt; false,
</span><span class='line'>        'product_ordering'                                 =&gt; false,
</span><span class='line'>        'refund_line_items'                                =&gt; false,
</span><span class='line'>        'delete_refund'                                    =&gt; false,
</span><span class='line'>        'rated'                                            =&gt; false,
</span><span class='line'>        'update_api_key'                                   =&gt; false,
</span><span class='line'>        'get_customer_location'                            =&gt; true,
</span><span class='line'>        'load_variations'                                  =&gt; false,
</span><span class='line'>        'save_variations'                                  =&gt; false,
</span><span class='line'>        'bulk_edit_variations'                             =&gt; false,
</span><span class='line'>        'tax_rates_save_changes'                           =&gt; false,
</span><span class='line'>        'shipping_zones_save_changes'                      =&gt; false,
</span><span class='line'>        'shipping_zone_add_method'                         =&gt; false,
</span><span class='line'>        'shipping_zone_methods_save_changes'               =&gt; false,
</span><span class='line'>        'shipping_zone_methods_save_settings'              =&gt; false,
</span><span class='line'>        'shipping_classes_save_changes'                    =&gt; false,
</span><span class='line'>    );
</span><span class='line'>    foreach ( $ajax_events as $ajax_event =&gt; $nopriv ) {
</span><span class='line'>        add_action( 'wp_ajax_woocommerce_' . $ajax_event, array( __CLASS__, $ajax_event ) );
</span><span class='line'>        if ( $nopriv ) {
</span><span class='line'>            add_action( 'wp_ajax_nopriv_woocommerce_' . $ajax_event, array( __CLASS__, $ajax_event ) );
</span><span class='line'>            // WC AJAX can be used for frontend ajax requests
</span><span class='line'>            add_action( 'wc_ajax_' . $ajax_event, array( __CLASS__, $ajax_event ) );
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>We wouldn&rsquo;t want to edit the plugin itself to add the custom endpoint and functions to the class because our code would be erased when the plugin updates itself. To avoid losing our code, a better way to add our codes is to extend the class. We could add it as a plugin or put just include it in the themes <code>functions.php</code>.</p>

<p>In my case, I created a separate file just for this class then used <code>include_once()</code> to load it through my themes <code>functions.php</code>.</p>

<pre><code>class Custom_WC_AJAX extends WC_AJAX {

    /**
     - Hook in ajax handlers.
     */
    public static function init() {
        add_action( 'init', array( __CLASS__, 'define_ajax' ), 0 );
        add_action( 'template_redirect', array( __CLASS__, 'do_wc_ajax' ), 0 );
        self::add_ajax_events();
    }

    /**
     - Get WC Ajax Endpoint.
     - @param  string $request Optional
     - @return string
     */
    public static function get_endpoint( $request = '' ) {
        return esc_url_raw( add_query_arg( 'wc-ajax', $request, remove_query_arg( array( 'remove_item', 'add-to-cart', 'added-to-cart' ) ) ) );
    }

    /**
     - Set WC AJAX constant and headers.
     */
    public static function define_ajax() {
        if ( ! empty( $_GET['wc-ajax'] ) ) {
            if ( ! defined( 'DOING_AJAX' ) ) {
                define( 'DOING_AJAX', true );
            }
            if ( ! defined( 'WC_DOING_AJAX' ) ) {
                define( 'WC_DOING_AJAX', true );
            }
            // Turn off display_errors during AJAX events to prevent malformed JSON
            if ( ! WP_DEBUG || ( WP_DEBUG &amp;&amp; ! WP_DEBUG_DISPLAY ) ) {
                @ini_set( 'display_errors', 0 );
            }
            $GLOBALS['wpdb']-&gt;hide_errors();
        }
    }

    /**
     - Send headers for WC Ajax Requests
     - @since 2.5.0
     */
    private static function wc_ajax_headers() {
        send_origin_headers();
        @header( 'Content-Type: text/html; charset=' . get_option( 'blog_charset' ) );
        @header( 'X-Robots-Tag: noindex' );
        send_nosniff_header();
        nocache_headers();
        status_header( 200 );
    }

    /**
     - Check for WC Ajax request and fire action.
     */
    public static function do_wc_ajax() {
        global $wp_query;
        if ( ! empty( $_GET['wc-ajax'] ) ) {
            $wp_query-&gt;set( 'wc-ajax', sanitize_text_field( $_GET['wc-ajax'] ) );
        }
        if ( $action = $wp_query-&gt;get( 'wc-ajax' ) ) {
            self::wc_ajax_headers();
            do_action( 'wc_ajax_' . sanitize_text_field( $action ) );
            die();
        }
    }

    /**
     - Add custom ajax events here
     */
    public static function add_ajax_events() {
        // woocommerce_EVENT =&gt; nopriv
        $ajax_events = array(
            'minicart_remove_item' =&gt; true,
        );
        foreach ( $ajax_events as $ajax_event =&gt; $nopriv ) {
            add_action( 'wp_ajax_woocommerce_' . $ajax_event, array( __CLASS__, $ajax_event ) );
            if ( $nopriv ) {
                add_action( 'wp_ajax_nopriv_woocommerce_' . $ajax_event, array( __CLASS__, $ajax_event ) );
                // WC AJAX can be used for frontend ajax requests
                add_action( 'wc_ajax_' . $ajax_event, array( __CLASS__, $ajax_event ) );
            }
        }
    }

    /**
     - Get a refreshed cart fragment. 
     - 
     - Copied from WC_AJAX but changed how data is returned. 
     - You can add fragments (DOM Objects loaded via AJAX) by adding them
     - through the 'add_to_cart_fragments'. 
     - It's better to do it this way so you don't have to create the DOM via
     - javascript because WooCommerce have a general javascript code that will
     - automatically change the DOM Object for all the fragments loaded
     - through here. I will give more info about this later.
     */
    public static function get_refreshed_fragments_raw() {
        // Get mini cart
        ob_start();
        woocommerce_mini_cart();
        $mini_cart = ob_get_clean();
        // Fragments and mini cart are returned
        $data = array(
            'fragments' =&gt; 
                apply_filters( 
                'woocommerce_add_to_cart_fragments', 
                array(
                    'div.widget_shopping_cart_content' =&gt; '&lt;div class="widget_shopping_cart_content"&gt;' . $mini_cart . '&lt;/div&gt;'
                )
            ),
            'cart_hash' =&gt; 
            apply_filters( 
                'woocommerce_add_to_cart_hash', 
                WC()-&gt;cart-&gt;get_cart_for_session() ? md5( json_encode( WC()-&gt;cart-&gt;get_cart_for_session() ) ) : '', 
                WC()-&gt;cart-&gt;get_cart_for_session() )
             );
        /**
         - Used 'return' here instead of 'wp_send_json()';
         */
        return ( $data ); 
    }
    /**
     - Removes item from the cart then returns a new fragment
     */
    public static function minicart_remove_item() {
        $cart_key = $_POST['cart_key'];
        if(!empty($cart_key)) {
            if( WC()-&gt;cart-&gt;remove_cart_item( $cart_key ) ){
                // Response
                $new_fragments = self::get_refreshed_fragments_raw();
                die(json_encode($new_fragments));
            }
        }
        die("error!!!!");
    }
}

$custom_wc_ajax = new Custom_WC_AJAX();
$custom_wc_ajax-&gt;init();
</code></pre>

<p>In the code sample above, I copied ix(6) functions from the parent class WC_AJAX that is needed to make the extend work. Then at the last part I just added my functions for the</p>

<ul>
<li><code>init()</code>,</li>
<li><code>get_endpoint</code>,</li>
<li><code>define_ajax*()</code>,</li>
<li><code>do_wc_ajax()</code>,</li>
<li><code>add_ajax_events()</code>,</li>
<li>and <code>get_refreshed_fragments</code> &ndash;> which I renamed to <code>get_refreshed_fragments_raw()</code></li>
</ul>


<p>The first 4 functions are only needed to initiate the class and we only need to edit <code>add_ajax_events()</code> and <code>get_refreshed_fragments()</code>. I had to rename <code>get_refreshed_fragments()</code> to <code>get_refreshed_fragments_raw()</code> because I needed it to return the data to the functions, not the browser.</p>

<h3><strong>Step 2. Adding your custom AJAX events</strong></h3>

<p>To add a custom event you just have to create a function within the class and and add the function name in <code>$ajax_events</code> array inside the <code>add_ajax_events()</code> function.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * Add custom ajax events here
</span><span class='line'> */
</span><span class='line'>public static function add_ajax_events() {
</span><span class='line'>    // woocommerce_EVENT =&gt; nopriv
</span><span class='line'>    $ajax_events = array(
</span><span class='line'>        'minicart_remove_item' =&gt; true,
</span><span class='line'>    );
</span><span class='line'>    foreach ( $ajax_events as $ajax_event =&gt; $nopriv ) {
</span><span class='line'>        add_action( 'wp_ajax_woocommerce_' . $ajax_event, array( __CLASS__, $ajax_event ) );
</span><span class='line'>        if ( $nopriv ) {
</span><span class='line'>            add_action( 'wp_ajax_nopriv_woocommerce_' . $ajax_event, array( __CLASS__, $ajax_event ) );
</span><span class='line'>            // WC AJAX can be used for frontend ajax requests
</span><span class='line'>            add_action( 'wc_ajax_' . $ajax_event, array( __CLASS__, $ajax_event ) );
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>}  
</span><span class='line'>
</span><span class='line'>public static function minicart_remove_item() {
</span><span class='line'>    
</span><span class='line'>    if(isset($_POST['cart_item_key'])) die("error!!!!");
</span><span class='line'>
</span><span class='line'>    $cart_item_key = $_POST['cart_item_key'];
</span><span class='line'>    if(!empty($cart_item_key)) {
</span><span class='line'>        if( WC()-&gt;cart-&gt;remove_cart_item( $cart_item_key ) ){
</span><span class='line'>            // Response
</span><span class='line'>            $new_fragments = self::get_refreshed_fragments_raw();
</span><span class='line'>            die(json_encode($new_fragments));
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>In the problem I&rsquo;m trying to solve we need to remove a cart item from the minicart without reloading the page. When I inspected the code for their remove button, it has the endpoint url to cart argument <code>remove_item</code> with the value <code>cart_item_key</code>. I created a new endpoint for it and then pass the <code>cart_item_key</code> via post method and used <code>WC()-&gt;cart-&gt;remove_cart_item( $cart_item_key )</code> to remove the item from the cart and return the new fragments for the mini-cart. Fragments are bits of html code that woocommerce uses as a template to attach new information to the UI. Custom fragments can be attached to the <code>add_to_fragments</code> filter. In this case, we don&rsquo;t have to create custom fragments. But I&rsquo;ll discuss it on another topic.</p>

<h3><strong>Step 3. Editing the mini-cart.php</strong></h3>

<p>In the default <code>mini-cart.php</code>, this is how the remove link is generated.</p>

<p>Source: <a href="https://github.com/woothemes/woocommerce/blob/master/templates/cart/mini-cart.php," title="https://github.com/woothemes/woocommerce/blob/master/templates/cart/mini-cart.php">https://github.com/woothemes/woocommerce/blob/master/templates/cart/mini-cart.php</a></p>

<pre><code>&lt;?php
echo apply_filters( 'woocommerce_cart_item_remove_link', sprintf(
    '&lt;a href="%s" class="remove" title="%s" data-product_id="%s" data-product_sku="%s"&gt;&amp;times;&lt;/a&gt;',
    esc_url( WC()-&gt;cart-&gt;get_remove_url( $cart_item_key ) ),
    __( 'Remove this item', 'woocommerce' ),
    esc_attr( $product_id ),
    esc_attr( $_product-&gt;get_sku() )
), $cart_item_key );
?&gt;
</code></pre>

<p>These are lines 45-53. I had to tweak this a bit to make it work with the behavior I want. In this sample code, you&rsquo;ll see that I changed <code>href</code> to a hash and added a <code>data-key</code> equal to the <code>$cart_item_key</code>. On line 48 instead of using <code>esc_url( WC()-&gt;cart-&gt;get_remove_url( $cart_item_key )</code>, I just used <code>esc_attr($cart_item_key)</code> to make it print just the <code>$cart_item_key</code>.</p>

<pre><code>&lt;?php
echo apply_filters( 'woocommerce_cart_item_remove_link', sprintf(
    '&lt;a href="#" data-key="%s" class="remove" title="%s" data-product_id="%s" data-product_sku="%s"&gt;&amp;times;&lt;/a&gt;',
    esc_attr( $cart_item_key ),
    __( 'Remove this item', 'woocommerce' ),
    esc_attr( $product_id ),
    esc_attr( $_product-&gt;get_sku() )
), $cart_item_key );
?&gt;
</code></pre>

<h3><strong>Step 4. Write JS to send post data to our custom endpoint.</strong></h3>

<p>Since the remove button has been modified, we&rsquo;ll now move on to writing the javascript code for it. I wanted to follow the standard of WooCommerce on their coding so I just copied the <code>add_to_cart.js</code> and modified it to my needs. Everything under the <code>$post()</code> refreshes the information from the fragments received in the <code>response</code> data, so it won&rsquo;t just remove the cart item but also attach the new data to the UI.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>jQuery( function( $ ) {
</span><span class='line'>        /* global jQuery, wc_add_to_cart_params */
</span><span class='line'>        if ( typeof wc_add_to_cart_params === 'undefined' ) {
</span><span class='line'>            return false;
</span><span class='line'>        }
</span><span class='line'>        // Ajax remove cart item
</span><span class='line'>        $( document ).on( 'click', 'a.remove', function(e) { // Remove button selector
</span><span class='line'>            e.preventDefault();
</span><span class='line'>            // AJAX add to cart request
</span><span class='line'>            var $thisbutton = $( this );
</span><span class='line'>            if ( $thisbutton.is( '.remove' ) ) {
</span><span class='line'>                //Check if the button has a product ID
</span><span class='line'>                if ( ! $thisbutton.attr( 'data-product_id' ) ) { 
</span><span class='line'>                    return true;
</span><span class='line'>                }
</span><span class='line'>                // Get Cart Key
</span><span class='line'>                var key = $thisbutton.data('key');
</span><span class='line'>                // Create Post Data
</span><span class='line'>                var data = {cart_key: key};
</span><span class='line'>               
</span><span class='line'>                // Ajax action
</span><span class='line'>                //passed`minicart_remove_item` endpoint and post dta
</span><span class='line'>                $.post( 
</span><span class='line'>                    wc_add_to_cart_params.wc_ajax_url.toString().replace( '%%endpoint%%', 'minicart_remove_item' ), 
</span><span class='line'>                    data, 
</span><span class='line'>                    function( response ) {
</span><span class='line'>                    if ( ! response ) {
</span><span class='line'>                        return;
</span><span class='line'>                    }
</span><span class='line'>                        var this_page = window.location.toString();
</span><span class='line'>                        $thisbutton.removeClass( 'loading' );
</span><span class='line'>                        var fragments = response.fragments;
</span><span class='line'>                        var cart_hash = response.cart_hash;
</span><span class='line'>                        // Block fragments class
</span><span class='line'>                        if ( fragments ) {
</span><span class='line'>                            $.each( fragments, function( key ) {
</span><span class='line'>                                $( key ).addClass( 'updating' );
</span><span class='line'>                            });
</span><span class='line'>                        }
</span><span class='line'>                        // Block widgets and fragments
</span><span class='line'>                        $( '.shop_table.cart, .updating, .cart_totals' ).fadeTo( '400', '0.6' ).block({
</span><span class='line'>                            message: null,
</span><span class='line'>                            overlayCSS: {
</span><span class='line'>                                opacity: 0.6
</span><span class='line'>                            }
</span><span class='line'>                        });
</span><span class='line'>                        // Replace fragments
</span><span class='line'>                        if ( fragments ) {
</span><span class='line'>                            $.each( fragments, function( key, value ) {
</span><span class='line'>                                $( key ).replaceWith( value );
</span><span class='line'>                            });
</span><span class='line'>                        }
</span><span class='line'>                        // Unblock
</span><span class='line'>                        $( '.widget_shopping_cart, .updating' ).stop( true ).css( 'opacity', '1' ).unblock();
</span><span class='line'>                        // Cart page elements
</span><span class='line'>                        $( '.shop_table.cart' ).load( this_page + ' .shop_table.cart:eq(0) &gt; *', function() {
</span><span class='line'>                            $( '.shop_table.cart' ).stop( true ).css( 'opacity', '1' ).unblock();
</span><span class='line'>                            $( document.body ).trigger( 'cart_page_refreshed' );
</span><span class='line'>                        });
</span><span class='line'>                        $( '.cart_totals' ).load( this_page + ' .cart_totals:eq(0) &gt; *', function() {
</span><span class='line'>                            $( '.cart_totals' ).stop( true ).css( 'opacity', '1' ).unblock();
</span><span class='line'>                        });
</span><span class='line'>                        // Trigger event so themes can refresh other areas
</span><span class='line'>                        $( document.body ).trigger( 'added_to_cart', [ fragments, cart_hash, $thisbutton ] );
</span><span class='line'>                },
</span><span class='line'>                'json');
</span><span class='line'>                e.preventDefault();
</span><span class='line'>                return false;
</span><span class='line'>            }
</span><span class='line'>            return false;
</span><span class='line'>            // return true;
</span><span class='line'>        });
</span><span class='line'>    });</span></code></pre></td></tr></table></div></figure>


<p>Upon testing this modification, for me, the mini-cart behavior became better. You can also add a quantity input field there and modify the quantity of each cart item without refreshing the page.</p>

<p>So that&rsquo;s it for now. I&rsquo;ll do another post about <code>fragments</code> in my next post. Thanks!</p>

      </div>
    </div>
  </div>
</article>

<hr class="divider-short"/>

<div class="archive-link">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-6 col-md-offset-3">
        
          <a class="pull-left" href="/blog/2015/06/10/making-angularjs-and-wordpress-work-together/" title="Previous Post: Making AngularJS and Wordpress Work Together">&laquo; Previous: Making AngularJS and Wordpress Work Together</a>
        

        
      </div>
    </div>
  </div>
</div>

    <footer id="footer" class="her-row">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
  <a class="footer-text" href="/"><h4>Home</h4></a>
</div>

<div class="col-md-2">
  <div class="social-icon-list">
    

    
    <a href="https://github.com/PatzMatias"><img src="/images/glyphicons_social_21_github.png"/></a>
    

    
    <a title="Google+" href="117521965885043360258"><img src="/images/glyphicons_social_02_google_plus.png"/></a>

    
    <a title="Facebook" href="https://facebook.com/patrick.matias"><img src="/images/glyphicons_social_30_facebook.png"/></a>

    
    <a href="mailto:patzmatias@gmail.com"><img src="/images/glyphicons_social_39_e-mail.png"/></a>
    
  </div>
</div>

<div class="pull-right">
  <h4 class="footer-text">Powered by <a href="http://octopress.org/">Octopress</a>
</div>


     	 <script src="/javascripts/main.js"></script>
     	 <script src="/javascripts/github.js" type="text/javascript"> </script>
      	 <script src="/javascripts/SmoothScroll.js"></script>
         <script src="/javascripts/skrollr.min.js"></script>
         <script type="text/javascript">
          var w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
          var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
          console.log(w);

          if(w>640)
  	    	  var s = skrollr.init({forceHeight: false});
          

		    </script>
         <script type="text/javascript">
          if (!window.jXHR){
              var jxhr = document.createElement('script');
              jxhr.type = 'text/javascript';
              jxhr.src = '/javascripts/libs/jXHR.js';
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(jxhr, s);
          }

          github.showRepos({
              user: 'PatzMatias',
              count: 3,
              skip_forks: true,
              target: '#gh_repos'
          });
    </script>
    </div>
  </div>
</footer>

  </body>
</html>
